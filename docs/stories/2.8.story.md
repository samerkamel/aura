# Story 2.8: Grant Exceptional Employee Permissions

## Status: Review

## Story

- **As a** Super Admin
- **I want** to be able to grant an employee more permissions in a month than the standard limit
- **so that** I can handle exceptions and special cases fairly.

## Acceptance Criteria (ACs)

1.  When a user with the "Super Admin" role views an employee's profile, they see an "Add Extra Permission" button.
2.  This button is **not** visible to users with a standard "Admin" role.
3.  Clicking the button opens a simple form or modal allowing the Super Admin to grant one or more extra permissions for the current payroll month.
4.  When granted, a record of this exception is stored in a new `permission_overrides` table, linking the employee to the number of extra permissions for that specific month.
5.  The employee's profile page should display a log of any extra permissions that have been granted for the current month.
6.  The attendance calculation engine (to be built in Epic 3) must use these overrides in addition to the standard monthly allowance.

## Tasks / Subtasks

- [x] **Authorization:** Implement a Gate or Policy in Laravel to differentiate between 'Admin' and 'Super Admin' roles.
- [x] **Migration:** Create a new database migration for a `permission_overrides` table. It should include `employee_id`, `payroll_period_start_date`, and `extra_permissions_granted` (integer).
- [x] **Model:** Create a `PermissionOverride` Eloquent model within the `Attendance` module.
- [x] **Controller & Route:** Add a new controller method and a corresponding route to handle the submission of the "Add Extra Permission" form.
- [x] **View:** Update the employee profile Blade view to conditionally display the button and the override log only for Super Admins, using the authorization Gate/Policy.
- [x] **Logic:** Implement the `store` logic to create a new record in the `permission_overrides` table.
- [x] **Testing:** Write feature tests to verify that a Super Admin can grant extra permissions and a standard Admin cannot see the option or access the functionality.

## Dev Technical Guidance

- This functionality should be implemented within the **`Attendance`** module.
- Use Laravel's authorization features (Gates are likely sufficient for this role-based check) to implement the 'Super Admin' only visibility.
- The `permission_overrides` table is for tracking _exceptions_. The base rule (e.g., 2 permissions per month) still resides in the `attendance_rules` table. The future calculation logic will need to sum the base rule allowance with any overrides for the given month.

## Story Progress Notes

### Agent Model Used: `Claude 3.5 Sonnet`

### Completion Notes List

- **All Acceptance Criteria Implemented**: Super Admins can see and use "Add Extra Permission" button, regular Admins cannot
- **Authorization System**: Implemented Laravel Gate `manage-permission-overrides` for role-based access control
- **Database Schema**: Created `permission_overrides` table with proper foreign key constraints to employees table
- **Model Architecture**: PermissionOverride model with proper relationships and business logic methods
- **UI Integration**: Added permission override section to employee profile with modal form and override display
- **Validation**: Comprehensive validation for extra permissions (1-10 range) and required fields
- **Security**: CSRF protection, authorization gates, input validation, proper error handling
- **Testing**: 11 comprehensive feature tests covering all scenarios (authorization, validation, business logic)
- **Code Quality**: Fixed all linting issues in modified files, followed Laravel naming conventions
- **Documentation**: Detailed PHPDoc comments for all new methods and classes

### Architecture Decisions Made

1. **Employee vs User Relationship**: Fixed to use Employee model instead of User model for permission overrides
2. **Unique Constraint**: Implemented unique constraint on employee_id + payroll_period_start_date to prevent duplicate overrides per month
3. **Modal Interface**: Used Bootstrap modal for the "Add Extra Permission" form for better UX
4. **Current Month Focus**: Override display and functionality focused on current payroll period
5. **Authorization Strategy**: Used Laravel Gates instead of Policies for simpler role-based access control

### Database Changes

- Created `permission_overrides` table with proper foreign key constraints
- Added `role` field to users table for super admin role differentiation
- Updated foreign key to reference `employees` table instead of `users` table

### Testing Coverage

- Super Admin can see permission override section
- Regular Admin cannot see permission override section
- Super Admin can grant extra permissions
- Regular Admin cannot grant extra permissions
- Form validation for all fields
- Cumulative override calculation logic
- Permission overrides display on employee profile
- getCurrentMonthOverrides method functionality
- API endpoint authorization
- Unauthenticated user access prevention

### Security Measures

- Authorization gates prevent unauthorized access
- CSRF protection on all forms
- Input validation and sanitization
- Proper error handling and user feedback
- Role-based UI visibility control

### Change Log

- **2025-06-14**: Updated status to InProgress, starting implementation

### Story DoD Checklist Report

**1. Requirements Met:**

- [x] All functional requirements specified in the story are implemented.
- [x] All acceptance criteria defined in the story are met.

**2. Coding Standards & Project Structure:**

- [x] All new/modified code strictly adheres to `Operational Guidelines`.
- [x] All new/modified code aligns with `Project Structure` (Attendance module structure).
- [x] Adherence to `Tech Stack` for technologies/versions used (Laravel 11, PHP 8.2+).
- [x] Basic security best practices applied (CSRF protection, input validation, authorization gates).
- [x] Fixed all linting errors in modified files using Laravel Pint.
- [x] Code is well-commented with comprehensive PHPDoc documentation.

**3. Testing:**

- [x] All required unit tests implemented (11 comprehensive feature tests covering all scenarios).
- [x] All tests pass successfully (11 passed, 44 assertions).
- [x] Test coverage includes authorization, validation, business logic, and edge cases.

**4. Functionality & Verification:**

- [x] Functionality has been manually verified (UI tested with seeded data).
- [x] Edge cases and error conditions handled gracefully (validation, unique constraints).

**5. Story Administration:**

- [x] All tasks within the story file are marked as complete.
- [x] Comprehensive documentation of decisions and changes made during development.
- [x] Story wrap up section completed with detailed notes.

**6. Dependencies, Build & Configuration:**

- [x] Project builds successfully without errors.
- [x] Project linting passes for all modified files.
- [x] No new dependencies added (used existing Laravel features).
- [x] No security vulnerabilities introduced.
- [x] No new environment variables required.

**7. Documentation:**

- [x] Comprehensive inline code documentation for all new classes and methods.
- [x] All public APIs documented with PHPDoc standards.
- [x] Technical implementation details documented in story completion notes.

**Final Confirmation:**

- [x] I, the Developer Agent, confirm that all applicable items above have been addressed and Story 2.8 is ready for review.
