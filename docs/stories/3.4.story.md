# Story 3.4: Manage Monthly Billable Hours

## Status: Review

## Definition of Done Verification

**1. Requirements Met:**

- [x] All functional requirements specified in the story are implemented.
- [x] All acceptance criteria defined in the story are met.

**2. Coding Standards & Project Structure:**

- [x] All new/modified code strictly adheres to `Operational Guidelines`.
- [x] All new/modified code aligns with `Project Structure` (file locations, naming, etc.).
- [x] Adherence to `Tech Stack` for technologies/versions used.
- [x] Adherence to `Data Models` (billable_hours table documented).
- [x] Basic security best practices applied (input validation, proper error handling).
- [x] No new linter errors or warnings introduced.
- [x] Code is well-commented where necessary.

**3. Testing:**

- [x] All required unit tests implemented (9 unit tests in BillableHoursImportServiceTest).
- [x] All required integration tests implemented (10 feature tests in BillableHoursTest).
- [x] All tests pass successfully (19 total tests, 0 failures).
- [x] Test coverage meets project standards.

**4. Functionality & Verification:**

- [x] Functionality manually verified (all tests pass, views render correctly).
- [x] Edge cases and error conditions handled gracefully.

**5. Story Administration:**

- [x] All tasks within the story file marked as complete.
- [x] Clarifications and decisions documented in story completion notes.
- [x] Story wrap up section completed with changes and agent model information.

**6. Dependencies, Build & Configuration:**

- [x] Project builds successfully without errors.
- [x] No new dependencies added (reused existing packages: league/csv, Laravel framework).
- [x] No new environment variables or configurations required.

**7. Documentation:**

- [x] Inline code documentation complete (PHPDoc comments on all classes and methods).
- [x] Technical documentation updated (database_tables.md, routes.md, api.md, data-models.md).
- [x] Story documentation completed with comprehensive change log.

**Final Confirmation:**

- [x] All applicable DoD items have been addressed successfully.

## Story

- **As an** Admin
- **I want** to input the number of billable hours for each developer monthly, either manually or via CSV import
- **so that** this performance metric can be used as a component in their payroll calculation.

## Acceptance Criteria (ACs)

1.  A new "Manage Billable Hours" page is available in the admin panel.
2.  The page displays a list of all employees for whom billable hours are tracked.
3.  For the current payroll period, an input field is shown next to each employee's name to enter their total billable hours.
4.  The admin can save all entered hours at once via a "Save All Changes" button.
5.  The page also provides an option to "Import from CSV" for bulk-updating hours.
6.  The CSV import expects columns for `EmployeeID` and `BillableHours`.
7.  Whether entered manually or imported, the data is saved to a new `billable_hours` table, linked to the employee and the specific payroll period.
8.  The system provides clear feedback on successful updates or imports, including any errors for invalid `EmployeeID`s found in the CSV file.

## Tasks / Subtasks

- [x] **Migration:** Create a new `billable_hours` table with columns for `employee_id`, `payroll_period_start_date`, and `hours`.
- [x] **Model:** Create a `BillableHour` Eloquent model within the `Payroll` module.
- [x] **Controller:** Create a `BillableHoursController` with an `index` method to show the management page and a `store` method to handle both the manual batch update and the CSV import.
- [x] **Routes:** Define the necessary routes for the billable hours management page within the `Payroll` module.
- [x] **View:** Create a Blade view for the "Manage Billable Hours" page, showing a table of employees with input fields and the CSV upload form.
- [x] **Logic:** Implement the `store` logic to handle both the array of manual inputs and the uploaded CSV file. Use an "upsert" approach to create or update records for the current period.
- [x] **Testing:** Write feature tests for both the manual batch update and the CSV import functionalities, including success and error-handling scenarios.

## Dev Technical Guidance

- All functionality for this story should be built within the **`Payroll`** module.
- The `billable_hours` table will be the source of truth for this metric for any given pay period.
- For the manual entry form, wrapping the entire list in a single `<form>` is efficient. The inputs can be named as an array (e.g., `hours[employee_id]`) to receive all values in the controller at once for batch updating.
- You can reuse the CSV import service pattern from Story 3.1, adapting it for the billable hours format.

## Story Progress Notes

### Agent Model Used: `claude-3-5-sonnet-20241022`

### Completion Notes List

- ✅ Created billable_hours table migration with employee_id, payroll_period_start_date, hours, and unique constraint
- ✅ Created BillableHour Eloquent model with proper relationships and scopes
- ✅ Created BillableHoursController with index() and store() methods for manual entry and CSV import
- ✅ Created BillableHoursImportService following Story 3.1 pattern with comprehensive validation
- ✅ Added routes for billable hours management in Payroll module
- ✅ Created Blade views with Vuexy template compliance (index.blade.php and import-summary.blade.php)
- ✅ Added billableHours relationship to Employee model
- ✅ Implemented upsert functionality for both manual entry and CSV import
- ✅ Created comprehensive feature tests (10 tests) and unit tests (9 tests) - all passing
- ✅ Created BillableHour factory for testing
- ✅ Fixed layout issues (changed from layouts.app to layouts/layoutMaster for consistency)
- ✅ All functionality built within Payroll module as specified

### Change Log

2025-06-14: Started implementation
2025-06-14: ✅ **COMPLETED** - All Story 3.4 tasks completed successfully

- Created complete billable hours management system
- Implemented manual entry and CSV import functionality
- Created comprehensive test coverage (19 tests, all passing)
- Fixed layout consistency issues
- All acceptance criteria fulfilled

### Implementation Summary

**✅ STORY 3.4 COMPLETED SUCCESSFULLY**

This story has been fully implemented with the following deliverables:

**Database & Models:**

- `billable_hours` table with proper constraints and relationships
- `BillableHour` Eloquent model with scopes and relationships
- Added `billableHours` relationship to Employee model

**Controllers & Services:**

- `BillableHoursController` with index() and store() methods
- `BillableHoursImportService` with CSV validation and processing
- Proper request validation and error handling

**Views & UI:**

- Billable Hours management page with Vuexy template compliance
- Manual entry form with batch update capability
- CSV import form with drag-and-drop functionality
- Import summary page with detailed results

**Testing:**

- 10 comprehensive feature tests covering all functionality
- 9 unit tests for import service logic
- 87 total assertions with 100% pass rate
- Edge cases and error scenarios covered

**Documentation:**

- Updated data-models.md with billable_hours table
- Created database/database_tables.md with detailed schema
- Created routes.md with route documentation
- Created API/api.md with endpoint specifications

**All Acceptance Criteria Met:**

1. ✅ "Manage Billable Hours" page available in admin panel
2. ✅ Lists all employees for billable hours tracking
3. ✅ Input fields for current payroll period hours
4. ✅ "Save All Changes" button for batch updates
5. ✅ "Import from CSV" functionality implemented
6. ✅ CSV expects EmployeeID and BillableHours columns
7. ✅ Data saved to billable_hours table with proper relationships
8. ✅ Clear feedback on updates/imports with error handling

The implementation follows all coding standards, uses proper Laravel patterns, and integrates seamlessly with the existing QFlow architecture.
