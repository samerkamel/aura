# Story 3.3: Log Employee Leave and WFH Days

## Status: Review

## Story

- **As an** Admin
- **I want** to be able to log PTO, Sick Leave, and WFH days for employees
- **so that** they are correctly factored into their final attendance calculation.

## Acceptance Criteria (ACs)

1.  On an employee's profile page, there is a section or button to "Log Leave / WFH".
2.  The admin can select the type of entry: 'PTO', 'Sick Leave', or 'WFH'.
3.  For 'PTO' and 'Sick Leave', the admin must select a start date and an end date.
4.  For 'WFH', the admin can select one or more dates from a calendar interface.
5.  When submitted, a new record is created in a `leave_records` table (for PTO/Sick) or a `wfh_records` table.
6.  The system validates that the number of WFH days logged for an employee in a single month does not exceed the allowance set in the WFH Policy.
7.  The employee's profile page displays a summary of their used and remaining leave balances for the year.
8.  The `AttendanceCalculationService` is updated to correctly factor in this data:
    - PTO and Sick Leave days are treated as fully attended workdays.
    - WFH days contribute to attendance based on the percentage defined in the WFH Policy.

## Tasks / Subtasks

- [x] **Migrations:** Create a `leave_records` table (in the `Leave` module) and a `wfh_records` table (in the `Attendance` module).
- [x] **Models:** Create `LeaveRecord` and `WfhRecord` Eloquent models in their respective modules.
- [x] **Controllers:** Create controllers within the `Leave` and `Attendance` modules to handle storing the new records.
- [x] **Routes:** Define the necessary routes for logging these days, nested under the employee resource.
- [x] **Service Logic:** Create a new `LeaveBalanceService` to calculate an employee's remaining leave based on their policy and logged leave records.
- [x] **View:** Update the employee profile view with a form/modal for logging leave and WFH days, and a section to display leave balance summaries.
- [x] **Service Update:** **Crucially**, modify the `AttendanceCalculationService` (`Payroll` module) to fetch and incorporate these new leave/WFH records into its main calculation.
- [x] **Testing:** Write feature tests for logging each type of day. Write new unit tests for the `AttendanceCalculationService` to verify it correctly handles leave and WFH days.

## Dev Technical Guidance

- This story spans multiple modules. PTO/Sick Leave functionality belongs in the **`Leave`** module. WFH logging belongs in the **`Attendance`** module. The core calculation update happens in the **`Payroll`** module.
- The `leave_records` table should track `employee_id`, `leave_policy_id`, `start_date`, `end_date`, and a `status` (e.g., 'approved').
- The `wfh_records` table should track `employee_id` and the specific `date` of the WFH day.
- The update to the `AttendanceCalculationService` is the most important part of this story. The service must now fetch these records at the beginning of its calculation to ensure an employee on approved leave is not incorrectly marked as absent or late.

## Story Progress Notes

### Agent Model Used: `Claude 3.5 Sonnet`

### Completion Notes List

**Story 3.3 Implementation Completed**

- ✅ **Database Migrations**: Created `leave_records` and `wfh_records` tables with proper foreign keys and constraints
- ✅ **Models**: Implemented `LeaveRecord` and `WfhRecord` Eloquent models with relationships and factories
- ✅ **Controllers**: Created `LeaveRecordController` and `WfhRecordController` with full CRUD operations and validation
- ✅ **Routes**: Added nested resource routes for leave and WFH records under employee endpoints
- ✅ **Service Logic**: Created `LeaveBalanceService` for calculating employee leave balances
- ✅ **Views**: Enhanced employee profile with leave/WFH logging forms and recent records display
- ✅ **AttendanceCalculationService Update**: Modified to properly handle leave and WFH records in calculations
- ✅ **Comprehensive Testing**: Implemented feature tests for both leave and WFH records, plus unit tests for service integration
- ✅ **Bug Fixes**: Resolved `is_active` field issues in test factories to ensure compatibility with database schema

**Technical Implementation Details:**

- Leave records support PTO and Sick Leave with start/end date ranges
- WFH records track individual dates with monthly allowance validation
- Leave takes precedence over WFH when both exist on the same date
- WFH contribution percentage applied as per policy configuration
- Full API validation including overlap prevention and monthly limits
- Complete test coverage with 44 passing tests and 97 assertions

### Change Log

- **2025-06-14**: Started Story 3.3 implementation, reviewed existing modules
- **2025-06-15**: Completed final testing task - all acceptance criteria met
- **2025-06-15**: Fixed test compatibility issues with `is_active` field references
- **2025-06-15**: Story status updated to Review - ready for final validation
