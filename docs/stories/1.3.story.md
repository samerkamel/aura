# Story 1.3: Manage Employee Documents

## Status: Done

## Story

- **As an** Admin
- **I want** to upload documents to an employee's profile (e.g., passport, contract) and set optional expiration dates
- **so that** I can track document validity.

## Acceptance Criteria (ACs)

1. ✅ When viewing an employee's profile, there is a dedicated "Documents" section.
2. ✅ The "Documents" section displays a list of already uploaded documents, showing the Document Type, Issue Date, Expiry Date, and a link to download the file.
3. ✅ The section contains an "Upload New Document" button or form.
4. ✅ The upload form includes fields for "Document Type" (text input), "Issue Date" (optional date picker), "Expiry Date" (optional date picker), and a file input.
5. ✅ The file input must only accept common document and image formats (e.g., PDF, DOCX, JPG, PNG).
6. ✅ The uploaded file size must be validated and not exceed a system-defined limit (e.g., 5MB).
7. ✅ Upon successful upload, the file is securely stored, and a corresponding record is created in the `employee_documents` table, linked to the correct employee.
8. ✅ The document list on the profile page updates immediately to show the newly uploaded document.
9. ✅ The admin can delete an existing document, which removes both the file from storage and the record from the database.

## Tasks / Subtasks

- [x] **Migration:** Create the database migration for the `employee_documents` table as defined in `docs/data-models.md`.
- [x] **Model:** Create the `EmployeeDocument` Eloquent model within the `HR` module.
- [x] **Relationship:** Add the `hasMany('documents')` relationship to the `Employee` model.
- [x] **Routes:** Define the necessary web routes for storing and destroying documents, nested under the employee resource (e.g., `POST /employees/{employee}/documents`).
- [x] **Controller:** Create an `EmployeeDocumentController` (or add methods to `EmployeeController`) to handle the `store` and `destroy` logic for documents.
- [x] **Validation:** Create a `StoreDocumentRequest` Form Request class to handle validation for the file upload (file types, size, required fields).
- [x] **File Storage:** Implement the file upload logic using Laravel's `Storage` facade, ensuring files are stored in a unique, employee-specific directory (e.g., `storage/app/public/documents/{employee_id}/`).
- [x] **View:** Update the employee profile view (`show.blade.php` or `edit.blade.php`) to include the "Documents" section, the upload form, and the list of documents with download/delete actions.
- [x] **Testing:** Write feature tests for uploading a document (with valid and invalid files) and deleting a document.

## Dev Technical Guidance

- All code for this story must be implemented within the `HR` module.
- Use Laravel's built-in `Storage` facade for all file operations. This will make it easy to change the storage driver (e.g., from local to AWS S3) in the future if needed.
- Ensure that download links are generated as secure, temporary URLs if the storage is not public.
- When a document record is deleted from the database, the corresponding physical file must also be deleted from storage to prevent orphaned files.

## Story Progress Notes

### Agent Model Used: `Claude 3.5 Sonnet`

### Completion Notes List

- **2025-06-14**: Story initialization - Status updated to InProgress
- **2025-06-14**: Beginning implementation of employee document management system
- **2025-06-14**: ✅ **COMPLETED** - All features implemented and tested successfully:
  - Database migration for employee_documents table created
  - EmployeeDocument model with comprehensive functionality created
  - Employee model relationship added (hasMany documents)
  - Routes configured for nested document operations
  - EmployeeDocumentController with store, download, and destroy methods
  - StoreDocumentRequest validation with file type and size limits
  - Employee show view enhanced with documents section and upload modal
  - Storage configuration and file handling implemented
  - Comprehensive test suite with 9 test cases covering all functionality
  - All code style checks passed
  - Story status updated to Done

### Change Log

- **2025-06-14**: Started Story 1.3 implementation
