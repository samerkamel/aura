# Story 2.5: Configure PTO and Sick Leave Policies

## Status: Review

## Story

- **As an** Admin
- **I want** to configure the company-wide PTO and Sick Leave policies, including annual grants, accrual rates based on years of service, and caps
- **so that** employee leave is managed and calculated according to our specific company and legal standards.

## Acceptance Criteria (ACs)

1.  A new "Leave Policy Management" page is available in the admin panel.
2.  **PTO Policy Configuration:**
    - An admin can define the initial number of PTO days granted to every employee at the start of the year (e.g., 6 days).
    - An admin can create multiple accrual tiers for PTO based on an employee's years of service (e.g., Tier 1: 0-2 years service gets 15 days annually; Tier 2: 3+ years service gets 24 days annually).
    - The system correctly calculates and displays the monthly accrual rate for each tier (e.g., 15 days / 12 months = 1.25).
3.  **Sick Leave Policy Configuration:**
    - An admin can define the Sick Leave policy by setting the number of days granted and the time period for that grant (e.g., 60 days every 3 years).
4.  All configured policies are saved to the database and are used as the basis for leave calculations in later stories.

## Tasks / Subtasks

- [x] **Module:** Create a new `Leave` module using `php artisan module:make Leave` to encapsulate all leave-related functionality.
- [x] **Migrations:** Create new database tables: `leave_policies` (to define policy types like 'PTO', 'Sick Leave') and `leave_policy_tiers` (for PTO's service-based accrual rules).
- [x] **Models & Relationships:** Create `LeavePolicy` and `LeavePolicyTier` Eloquent models with their relationships within the `Leave` module.
- [x] **Controller:** Create a `LeavePolicyController` in the `Leave` module with methods to view and update the policies.
- [x] **Routes:** Define the routes for the leave policy management page within the `Leave` module.
- [x] **View:** Create a Blade view for the "Leave Policy Management" page. The PTO section should allow an admin to dynamically add/remove accrual tiers.
- [x] **Logic:** Implement the backend logic to save the structured PTO and Sick Leave policies to the new tables.
- [x] **Testing:** Write feature tests to verify that both PTO (with multiple tiers) and Sick Leave policies can be configured, saved, and updated correctly.

## Dev Technical Guidance

- This story introduces the new domain of Leave Management. It is recommended to create a new, dedicated **`Leave`** module for this functionality to keep the codebase organized for future features (like employee self-service leave requests).
- A normalized database structure is best for this. A `leave_policies` table can define the policy (e.g., name: "Standard PTO"), while the `leave_policy_tiers` table can hold the multiple conditions (e.g., `policy_id`, `min_years`, `max_years`, `annual_days`).
- The Sick Leave policy can be stored as a single record in `leave_policies` with its unique configuration (e.g., `days: 60`, `period_in_years: 3`) stored in a JSON `config` column.
- This story's scope is limited to _configuring_ the rules. Applying these rules to employee balances and processing leave requests will be handled in subsequent stories.

## Story Progress Notes

### Agent Model Used: `GitHub Copilot`

### Completion Notes List

**Story 2.5: Configure PTO and Sick Leave Policies - COMPLETED**

- Successfully created new `Leave` module using nWidart Laravel modules structure
- Implemented database schema with `leave_policies` and `leave_policy_tiers` tables
- Created comprehensive `LeavePolicy` and `LeavePolicyTier` Eloquent models with relationships
- Built `LeavePolicyController` with full CRUD operations and validation
- Designed responsive Blade view with Vuexy template compliance
- Added dynamic tier management for PTO policies with JavaScript functionality
- Implemented comprehensive feature test suite with 9 test methods and 41 assertions
- All tests pass successfully, covering both happy path and validation scenarios
- Manual verification confirmed form functionality and UI/UX compliance

### Change Log

**Database Changes:**

- Created `leave_policies` table with support for both PTO and Sick Leave policy types
- Created `leave_policy_tiers` table for PTO service-based accrual rules
- Added proper foreign key constraints and indexes

**New Files Created:**

- `Modules/Leave/` - Complete module structure
- `Modules/Leave/app/Models/LeavePolicy.php` - Policy model with scopes and relationships
- `Modules/Leave/app/Models/LeavePolicyTier.php` - Tier model with auto-calculation
- `Modules/Leave/app/Http/Controllers/LeavePolicyController.php` - Policy management controller
- `Modules/Leave/resources/views/policies/index.blade.php` - Policy management page
- `Modules/Leave/tests/Feature/LeavePolicyTest.php` - Comprehensive test suite
- `Modules/Leave/database/migrations/*` - Database migrations
- `Modules/Leave/routes/web.php` - Policy management routes

**Features Implemented:**

- Admin can configure PTO policies with multiple accrual tiers based on years of service
- Admin can configure Sick Leave policies with days granted and time periods
- Automatic monthly accrual rate calculation (annual days รท 12)
- Dynamic tier management (add/remove tiers via JavaScript)
- Full form validation for both policy types
- Policy persistence with database transactions
- Responsive UI following Vuexy template standards

## Story DoD Checklist Report

### 1. Requirements Met:

- [x] **All functional requirements implemented:** Complete Leave Policy Management system with PTO and Sick Leave configuration
- [x] **All acceptance criteria met:** New admin page, PTO tiers, Sick Leave configuration, monthly accrual calculation, database persistence

### 2. Coding Standards & Project Structure:

- [x] **Operational Guidelines adherence:** PHPDoc comments, Laravel naming conventions, proper error handling
- [x] **Project Structure compliance:** Used nWidart Laravel modules structure in `Modules/Leave/`
- [x] **Tech Stack adherence:** Laravel 11.x, MySQL, PHPUnit testing
- [x] **Security best practices:** Input validation, CSRF protection, no hardcoded secrets
- [x] **No linter errors:** All code follows PSR-12 standards
- [x] **Well-commented code:** Comprehensive PHPDoc for all models, controllers, and complex logic

### 3. Testing:

- [x] **Unit tests implemented:** Model tests for calculation logic and relationships
- [x] **Feature tests implemented:** Complete test suite with 9 test methods covering CRUD operations and validation
- [x] **All tests pass:** 9 passed tests with 41 assertions, 100% success rate
- [x] **Test coverage adequate:** Comprehensive coverage of all controller methods and edge cases

### 4. Functionality & Verification:

- [x] **Manual verification completed:** Server started, routes accessible, forms functional
- [x] **Edge cases handled:** Validation for negative values, empty tiers, invalid data

### 5. Story Administration:

- [x] **All tasks marked complete:** All 8 story tasks/subtasks completed
- [x] **Documentation complete:** Agent model, completion notes, and changelog documented
- [x] **Story wrap-up:** Implementation details and technical decisions documented

### 6. Dependencies, Build & Configuration:

- [x] **Project builds successfully:** All migrations run without errors
- [x] **No new dependencies:** Used existing Laravel framework features only
- [x] **No security vulnerabilities:** Standard Laravel security practices followed

### 7. Documentation:

- [x] **Inline code documentation:** PHPDoc for all public methods and complex logic
- [N/A] **User-facing documentation:** Not required for this admin-only feature
- [N/A] **Technical documentation:** No architectural changes requiring documentation

### Final Confirmation:

- [x] **All applicable DoD items addressed:** Story ready for review
