# Story 2.4: Configure Monthly Employee Permissions

## Status: Review

## Story

- **As an** Admin
- **I want** to define the length and maximum number of "permissions" an employee can take per month
- **so that** this time is correctly accounted for and not treated as a penalty.

## Acceptance Criteria (ACs)

1.  On the "Attendance Rules" management page, there is a section for "Employee Permissions".
2.  This section has a form with two numeric inputs: "Max Permissions Per Month" and "Length of Each Permission (in minutes)".
3.  The form's inputs must be validated as positive numbers.
4.  When saved, this configuration is stored as a single rule in the `attendance_rules` table with a `rule_type` of 'permission'.
5.  The `config` column for the record stores the two values as JSON (e.g., `{"max_per_month": 2, "minutes_per_permission": 60}`).
6.  Saving the form should update the existing 'permission' rule if one already exists (upsert logic).

## Tasks / Subtasks

- [x] **Controller:** Add functionality to the `AttendanceRuleController` to handle storing the 'permission' rule type.
- [x] **View:** Update the `index.blade.php` for attendance rules to include a form for the "Employee Permissions" settings.
- [x] **Logic:** Implement the `store` method with an "upsert" capability for the 'permission' rule type, as there should only ever be one such rule.
- [x] **Testing:** Write a feature test to verify that the permission rule can be successfully created and updated.

## Dev Technical Guidance

- This new rule configuration should be added to the existing "Attendance Rules" page within the **`Attendance`** module.
- Use the `attendance_rules` table and a `rule_type` of `'permission'`.
- The `config` JSON column should store both `max_per_month` and `minutes_per_permission`.
- Because there is only one system-wide rule for permissions, the logic should update the existing record if found, or create it if it doesn't exist.

## Story Progress Notes

## Story Progress Notes

### Agent Model Used: `claude-3-5-sonnet-20241022`

### Story DoD Checklist Report

**1. Requirements Met:**

- [x] All functional requirements specified in the story are implemented.
- [x] All acceptance criteria defined in the story are met.

**2. Coding Standards & Project Structure:**

- [x] All new/modified code strictly adheres to `Operational Guidelines`.
- [x] All new/modified code aligns with `Project Structure` (file locations, naming, etc.).
- [x] Adherence to `Tech Stack` for technologies/versions used.
- [N/A] Adherence to `Api Reference` and `Data Models` (no API changes made).
- [x] Basic security best practices applied (input validation, CSRF protection, proper error handling).
- [x] Minor linting warnings about duplicated validation strings are acceptable for clarity.
- [x] Code is well-commented where necessary.

**3. Testing:**

- [x] All required unit tests implemented (comprehensive feature tests covering all scenarios).
- [N/A] Integration tests (feature tests cover the required integration testing).
- [x] All tests pass successfully (25 tests, 121 assertions).
- [x] Test coverage meets project standards.

**4. Functionality & Verification:**

- [x] Functionality verified through comprehensive automated tests.
- [x] Edge cases and error conditions handled gracefully (validation, upsert logic).

**5. Story Administration:**

- [x] All tasks within the story file are marked as complete.
- [x] Clarifications and decisions documented in the story file.
- [x] Story wrap up section completed with detailed notes and changelog.

**6. Dependencies, Build & Configuration:**

- [x] Project builds successfully without errors.
- [x] Project linting passes (minor acceptable warnings about validation strings).
- [N/A] No new dependencies added.
- [N/A] No new environment variables or configurations introduced.

**7. Documentation:**

- [x] Relevant inline code documentation complete (PHPDoc comments).
- [N/A] User-facing documentation (no end-user documentation changes needed).
- [N/A] Technical documentation (no significant architectural changes).

**Final Confirmation:**

- [x] All applicable items above have been addressed.

### Completion Notes List

- All acceptance criteria have been implemented and tested
- Employee Permissions section added to Attendance Rules page with proper form
- Upsert functionality implemented - only one permission rule can exist at a time
- Comprehensive validation for both max_per_month (1-31) and minutes_per_permission (1-1440)
- Form displays existing data when permission rule exists
- All feature tests pass (25 tests, 121 assertions total)
- UI follows Vuexy template standards with proper form styling and user feedback
- Added getPermissionRule() method to AttendanceRule model for easy access

### Change Log

- 2025-06-14: Story status updated to InProgress, beginning development
- 2025-06-14: Added getPermissionRule() method to AttendanceRule model
- 2025-06-14: Extended AttendanceRuleController with storePermissionRule() method
- 2025-06-14: Updated store() method to route permission rule types correctly
- 2025-06-14: Added Employee Permissions section to index.blade.php with complete form
- 2025-06-14: Added comprehensive feature tests covering all permission rule functionality
- 2025-06-14: All tasks completed, ready for review
