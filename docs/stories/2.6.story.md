# Story 2.6: Configure Work-From-Home (WFH) Policy

## Status: Review

## Story

- **As an** Admin
- **I want** to configure the Work-From-Home (WFH) policy
- **so that** I can set the maximum allowed days per month and define how a WFH day contributes to an employee's total attendance.

## Acceptance Criteria (ACs)

1.  On the "Attendance Rules" management page, there is a section for "Work-From-Home (WFH) Policy".
2.  This section has a form with two numeric inputs: "Max WFH Days Per Month" and "Attendance Value (%)".
3.  The inputs must be validated (e.g., days must be a positive integer, percentage must be between 0 and 100).
4.  When saved, this configuration is stored as a single rule in the `attendance_rules` table with a `rule_type` of 'wfh_policy'.
5.  The `config` column for the record stores the two values as JSON (e.g., `{"max_days_per_month": 5, "attendance_percentage": 80}`).
6.  Saving the form should update the existing 'wfh_policy' rule if one already exists (upsert logic).

## Tasks / Subtasks

- [x] **Controller:** Add functionality to the `AttendanceRuleController` to handle storing the 'wfh_policy' rule type.
- [x] **View:** Update the `index.blade.php` for attendance rules to include a form for the WFH Policy settings.
- [x] **Logic:** Implement the `store` method with "upsert" logic for the 'wfh_policy' rule type, as there is only one system-wide policy.
- [x] **Testing:** Write a feature test to verify that the WFH policy can be successfully created and updated.

## Dev Technical Guidance

- This new rule configuration should be added to the existing "Attendance Rules" page within the **`Attendance`** module.
- Use the `attendance_rules` table with the `rule_type` of `'wfh_policy'`.
- The `config` JSON column should store both `max_days_per_month` and `attendance_percentage`.
- The logic for saving this rule should be an "upsert" since there is only one system-wide WFH policy.

## Story Progress Notes

## Story Progress Notes

### Agent Model Used: GitHub Copilot

### Completion Notes List

1. **WFH Policy Form Added**: Successfully integrated a Work-From-Home Policy section into the existing Attendance Rules index page with two inputs:

   - Max WFH Days Per Month (1-31)
   - Attendance Value (%) (0-100)

2. **Controller Enhancement**: Enhanced `AttendanceRuleController` with:

   - New `storeWfhPolicyRule()` method implementing upsert logic
   - Validation constants to avoid code duplication
   - Proper validation for both numeric inputs with appropriate error messages

3. **Model Extension**: Extended `AttendanceRule` model with:

   - `getWfhPolicyRule()` method to retrieve the single system-wide WFH policy
   - The `TYPE_WFH_POLICY` constant was already defined

4. **Comprehensive Testing**: Added 4 comprehensive feature tests covering:

   - Creating new WFH policy rules
   - Updating existing WFH policy rules (upsert functionality)
   - Validation rules for both inputs
   - Model method functionality

5. **Code Quality**: Ensured code follows PSR-12 standards using Laravel Pint and addressed all linting issues

### Change Log

**Files Modified:**

- `/Modules/Attendance/resources/views/rules/index.blade.php`: Added WFH Policy form section
- `/Modules/Attendance/app/Http/Controllers/AttendanceRuleController.php`: Added WFH policy handling and validation constants
- `/Modules/Attendance/app/Models/AttendanceRule.php`: Added `getWfhPolicyRule()` method
- `/Modules/Attendance/tests/Feature/AttendanceRuleTest.php`: Added 4 comprehensive WFH policy tests

**Key Implementation Details:**

- JSON config structure: `{"max_days_per_month": 5, "attendance_percentage": 80}`
- Upsert logic ensures only one system-wide WFH policy exists
- Form validation prevents invalid input (days: 1-31, percentage: 0-100)
- Consistent UI/UX with existing rule sections using Vuexy template styling

## Story DoD Checklist Report

**1. Requirements Met:**

- [x] All functional requirements specified in the story are implemented.
- [x] All acceptance criteria defined in the story are met.

**2. Coding Standards & Project Structure:**

- [x] All new/modified code strictly adheres to Operational Guidelines.
- [x] All new/modified code aligns with Project Structure (modular architecture).
- [x] Adherence to Tech Stack for technologies/versions used.
- [N/A] Adherence to Api Reference and Data Models (no API changes).
- [x] Basic security best practices applied (input validation, proper error handling).
- [x] No new linter errors or warnings introduced.
- [x] Code is well-commented with PHPDoc where necessary.

**3. Testing:**

- [x] All required unit tests implemented (4 comprehensive WFH policy tests).
- [N/A] Integration tests (feature tests cover the integration aspects).
- [x] All tests pass successfully (29 tests, 144 assertions).
- [x] Test coverage meets project standards.

**4. Functionality & Verification:**

- [x] Functionality manually verified through automated tests.
- [x] Edge cases and error conditions handled gracefully.

**5. Story Administration:**

- [x] All tasks within the story file are marked as complete.
- [x] Clarifications and decisions documented in completion notes.
- [x] Story wrap up section completed with change log and agent model info.

**6. Dependencies, Build & Configuration:**

- [x] Project builds successfully without errors.
- [x] Project linting passes (Laravel Pint).
- [N/A] No new dependencies added.
- [N/A] No new environment variables or configurations introduced.

**7. Documentation:**

- [x] Relevant inline code documentation (PHPDoc) complete.
- [N/A] User-facing documentation (internal admin feature, no user impact).
