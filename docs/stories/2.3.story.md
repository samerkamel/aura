# Story 2.3: Configure Tiered Late-in Penalty Rules

## Status: Review

## Story

- **As an** Admin
- **I want** to create multiple, tiered late-in penalty rules
- **so that** I can apply different deductions based on how late an employee signs in.

## Acceptance Criteria (ACs)

1.  On the "Attendance Rules" management page, there is a distinct section for "Late-in Penalties".
2.  The admin can view a list of all existing penalty rules in this section.
3.  The admin has an "Add Penalty Rule" button.
4.  The form for a new penalty rule requires two numeric inputs: "If Late By (minutes)" and "Deduct (minutes)".
5.  Upon saving, a new record is created in the `attendance_rules` table with `rule_type` set to 'late_penalty'.
6.  The `config` column for the new record must store the two values as JSON (e.g., `{"late_minutes": 30, "penalty_minutes": 60}`).
7.  The system must allow for multiple 'late_penalty' rules to exist at the same time (e.g., one for 15 mins, one for 30, one for 60).
8.  The admin can delete an existing penalty rule from the list.

## Tasks / Subtasks

- [x] **Controller:** Add functionality to the `AttendanceRuleController` to handle the creation and deletion of 'late_penalty' rule types.
- [x] **Routes:** Ensure the routes for the `AttendanceRuleController` support the `store` and `destroy` actions for these new rules.
- [x] **View:** Update the `index.blade.php` for attendance rules to include a table for listing existing penalty rules and a button to add a new one.
- [x] **View:** Create a form (can be a modal or a separate page) for adding a new penalty rule.
- [x] **Logic:** Implement the `store` method. Unlike the previous story, this should always create a new record, not update an existing one.
- [x] **Logic:** Implement the `destroy` method to delete a specific penalty rule by its ID.
- [x] **Testing:** Write feature tests to verify that multiple, distinct penalty rules can be created and that an individual rule can be deleted.

## Dev Technical Guidance

- This functionality should be added to the existing "Attendance Rules" page created in the previous story.
- When storing this rule, use the `rule_type` of `'late_penalty'`. The `config` JSON column should store both `late_minutes` and `penalty_minutes`.
- The system design should anticipate that the future calculation engine will need to evaluate all penalty rules and apply the correct one based on the employee's actual sign-in time.

## Story Progress Notes

### Agent Model Used: `claude-3-5-sonnet-20241022`

### Story DoD Checklist Report

**1. Requirements Met:**

- [x] All functional requirements specified in the story are implemented.
- [x] All acceptance criteria defined in the story are met.

**2. Coding Standards & Project Structure:**

- [x] All new/modified code strictly adheres to `Operational Guidelines`.
- [x] All new/modified code aligns with `Project Structure` (file locations, naming, etc.).
- [x] Adherence to `Tech Stack` for technologies/versions used.
- [N/A] Adherence to `Api Reference` and `Data Models` (no API changes made).
- [x] Basic security best practices applied (input validation, CSRF protection, proper error handling).
- [x] No new linter errors or warnings introduced (minor formatting issues fixed).
- [x] Code is well-commented where necessary.

**3. Testing:**

- [x] All required unit tests implemented (comprehensive feature tests covering all scenarios).
- [N/A] Integration tests (feature tests cover the required integration testing).
- [x] All tests pass successfully (19 tests, 87 assertions).
- [x] Test coverage meets project standards.

**4. Functionality & Verification:**

- [x] Functionality verified through comprehensive automated tests.
- [x] Edge cases and error conditions handled gracefully (validation, confirmation dialogs).

**5. Story Administration:**

- [x] All tasks within the story file are marked as complete.
- [x] Clarifications and decisions documented in the story file.
- [x] Story wrap up section completed with detailed notes and changelog.

**6. Dependencies, Build & Configuration:**

- [x] Project builds successfully without errors.
- [x] Project linting passes (formatting issues resolved).
- [N/A] No new dependencies added.
- [N/A] No new environment variables or configurations introduced.

**7. Documentation:**

- [x] Relevant inline code documentation complete (PHPDoc comments).
- [N/A] User-facing documentation (no end-user documentation changes needed).
- [N/A] Technical documentation (no significant architectural changes).

**Final Confirmation:**

- [x] All applicable items above have been addressed.

### Completion Notes List

- All acceptance criteria have been implemented and tested
- Late penalty rules can be created with validation for both late_minutes and penalty_minutes
- Multiple penalty rules can coexist simultaneously
- Rules are displayed in separate sections on the index page (Flexible Hours vs Late-in Penalties)
- Delete functionality works with confirmation dialogs
- All feature tests pass (19 tests, 87 assertions)
- UI follows Vuexy template standards with modals and proper form styling

### Change Log

- 2025-06-14: Story status updated to InProgress, beginning development
- 2025-06-14: Extended AttendanceRuleController with new store logic for late penalties and destroy method
- 2025-06-14: Added DELETE route for penalty rule deletion
- 2025-06-14: Completely redesigned index.blade.php with separate sections and modal form
- 2025-06-14: Added comprehensive feature tests covering all penalty rule functionality
- 2025-06-14: Fixed minor test issues and formatting problems
- 2025-06-14: All tasks completed, ready for review
